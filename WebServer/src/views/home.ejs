<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
        <link rel="stylesheet" href="css/style.css" />
        <title>Smart Parking System</title>
    </head>
    <body>
        <div class="container">
            <div class="slot__container">
                <div class="row"></div>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            let slotListFE = [];

            const renderSlotList = (slotList) => {
                const slotContainer = document.querySelector('.slot__container .row');

                var htmls = slotList.map(function (slot) {
                    let BgColor = '';
                    if (slot.isBooked) {
                        BgColor = 'bg-warning';
                    } else if (!slot.isBlank) {
                        BgColor = 'bg-danger';
                    } else {
                        // slot.isBlank && !slot.isBooked
                        BgColor = 'bg-success';
                    }

                    const Cursor = !slot.isBlank ? '' : 'cursor';
                    return `<div class="slot__item col ${BgColor} ${Cursor}" dataId="${slot.slotNumber}">
                                <b>Slot ${slot.slotNumber}</b>
                            </div>`;
                });

                slotContainer.innerHTML = htmls.join('');

                const slotBtns = document.querySelectorAll('.slot__item');

                slotBtns.forEach((slotBtn) => {
                    // Booking cannot be cancelled when slot is not blank
                    if (!slotListFE[slotBtn.getAttribute('dataId')].isBlank) {
                        return;
                    }

                    slotBtn.addEventListener('click', async (e) => {
                        const slotNumber = e.target.getAttribute('dataId');

                        slotListFE[slotNumber].isBooked = !slotListFE[slotNumber].isBooked;

                        console.log('slotListFE', slotListFE);

                        await fetch(`<%= url %>:<%= port %>/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(slotListFE[slotNumber]),
                        })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then((data) => {
                                console.log('Success:', data);
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                    });
                });
            };

            const fetchSlotList = async () => {
                await fetch(`<%= url %>:<%= port %>/iot/`)
                    .then((resoponse) => {
                        return resoponse.json();
                    })
                    .then((slotList) => {
                        console.log('slotList', slotList);
                        slotListFE = slotList;
                        renderSlotList(slotList);
                    });
            };

            window.addEventListener('load', async () => {
                await fetchSlotList();

                // Socket.io
                const socket = io();

                socket.on('fetch slot data', async (message) => {
                    console.log(message);
                    await fetchSlotList();
                });
            });
        </script>
    </body>
</html>
